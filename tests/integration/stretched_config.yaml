defaults:
- data: zarr
- dataloader: native_grid
- diagnostics: evaluation
- hardware: example
- graph: stretched_grid
- model: graphtransformer
- training: default
- _self_

no_validation: True

dataloader:
  dataset:
    cutout:
      - dataset: ${hardware.files.dataset}
        thinning: 25
      - dataset: ${hardware.files.forcing_dataset}
    adjust: all
    min_distance_km: 0
  num_workers:
    training: 1
  limit_batches:
      training: 100
      validation: 100
  training:
    start: "2017-01-01"
    end: "2017-01-07"
  validation:
    start: "2018-01"
    end: "2018-02"

data:
  forcing:
  - "cos_latitude"
  - "cos_longitude"
  - "sin_latitude"
  - "sin_longitude"
  - "cos_julian_day"
  - "cos_local_time"
  - "sin_julian_day"
  - "sin_local_time"
  - "lsm"
  # features that are only part of the forecast state
  # but are not used as the input to the model
  diagnostic:
  - tp
  remapped:
  normalizer:
    default: "mean-std"
    std:
    - "tp"
    min-max:
    max:
    none:
    - "cos_latitude"
    - "cos_longitude"
    - "sin_latitude"
    - "sin_longitude"
    - "cos_julian_day"
    - "cos_local_time"
    - "sin_julian_day"
    - "sin_local_time"
    - "lsm"

training:
  loss_scaling:
    spatial:
      _target_: anemoi.training.data.scaling.ReweightedGraphAttribute
      target_nodes: ${graph.data}
      scaled_attribute: area_weight # it must be a node attribute of the output nodes
      cutout_weight_frac_of_global: 2
  max_epochs: 2

hardware:
  files:
    dataset: cerra-rr-an-oper-0001-mars-5p5km-1984-2020-6h-v2-hmsi
    forcing_dataset: aifs-od-an-oper-0001-mars-o96-2016-2023-6h-v6
    graph: test_stretched_graph.pt
  paths:
    grids: null
    output: ${oc.env:PWD}/tmp_output/

  # number of GPUs per node and number of nodes (for DDP)
  accelerator: auto
  num_gpus_per_node: 1
  num_nodes: 1
  num_gpus_per_model: 1

graph:
  overwrite: True
  nodes:
    data:
      node_builder:
        _target_: anemoi.graphs.nodes.ZarrDatasetNodes
        dataset: ${dataloader.dataset}
      attributes:
        weights:
          _target_: anemoi.graphs.nodes.attributes.SphericalAreaWeights
          norm: unit-max
        cutout_mask:
          _target_: anemoi.graphs.nodes.attributes.CutOutMask
    hidden:
      node_builder:
        _target_: anemoi.graphs.nodes.StretchedTriNodes
        lam_resolution: 5
        global_resolution: 3
        reference_node_name: data
        mask_attr_name: cutout_mask

  edges:
    - source_name: data
      target_name: hidden
      edge_builders:
      - _target_: anemoi.graphs.edges.KNNEdges
        num_nearest_neighbours: 12
      attributes: ${graph.attributes.edges}
    - source_name: hidden
      target_name: hidden
      edge_builders:
      - _target_: anemoi.graphs.edges.MultiScaleEdges
        x_hops: 1
      attributes: ${graph.attributes.edges}
    - source_name: hidden
      target_name: data
      edge_builders:
      - _target_: anemoi.graphs.edges.KNNEdges
        num_nearest_neighbours: 3
      attributes: ${graph.attributes.edges}

  # model:
  #   attributes:
  #     edges: []
